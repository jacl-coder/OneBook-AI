# OneBook AI 前端开发流程（最佳实践版）

本文档用于指导本项目前端实现，目标是以最小返工完成可答辩、可演示、可扩展的交付。

## 1. 项目目标与范围
- 目标：完成核心闭环 `登录 -> 上传书籍 -> 状态轮询 -> 对话问答 -> 历史查看`。
- 接口边界：前端仅调用 Gateway（`http://localhost:8080`），不直接访问内部服务。
- 联调基线：以 `docs/backend_handoff.md` 和 OpenAPI 为准。

## 2. 开发总原则（行业通用）
- 先定契约再写页面：先锁定接口、错误码、状态机，再实现 UI。
- 先主流程后增强项：优先打通核心闭环，再做动画/细节优化。
- 可观测优先：每个关键请求都有 loading、empty、error 三态。
- 安全默认开启：token 管理、401 自动刷新、最小权限、输入校验。
- 小步迭代：每个阶段都可独立演示与验收。

## 3. 分阶段实施

## 阶段 0：契约冻结（必须先做）
- 工作内容：
  - 确认核心接口：`/api/auth/*`、`/api/books*`、`/api/chats`、`/api/users/me`。
  - 确认书籍状态机：`queued -> processing -> ready | failed`。
  - 确认 token 机制：`401 -> refresh -> retry`。
- 产出物：
  - 一份前端 API 清单（请求、响应、错误码）。
  - 一份状态流转图（上传与问答）。
- DoD：
  - 团队对接口语义无歧义。
  - 前端不再依赖“猜测后端行为”。

## 阶段 1：工程脚手架与质量门禁
- 工作内容：
  - 建立前端工程（推荐：React + TypeScript + Vite）。
  - 配置基础规范：ESLint、Prettier、路径别名、环境变量。
  - 建立网络层与统一错误处理中间件。
  - 建立路由守卫与鉴权态管理。
- 产出物：
  - 可运行基础项目与目录结构。
  - CI 最低校验：`lint + type-check + test`。
- DoD：
  - 新页面接入成本低。
  - 出错能在开发阶段被快速发现。

## 阶段 2：设计系统与信息架构
- 工作内容：
  - 定义设计 token（颜色、间距、圆角、阴影、字体、状态色）。
  - 统一组件规范：按钮、输入框、卡片、表格、弹窗、Toast、Skeleton。
  - 统一交互规范：loading/empty/error/success。
- 产出物：
  - `UI Foundation` 页面（展示基础组件状态）。
  - 页面结构草图：登录页、书库页、上传流程、对话页。
- DoD：
  - 组件可复用，避免每页重复造轮子。
  - 所有异步操作都具备明确反馈。

## 阶段 3：API 层与认证闭环
- 工作内容：
  - 实现 `auth` 模块：登录/注册/登出/刷新。
  - 实现请求拦截器：自动带 `Authorization`。
  - 实现响应拦截器：遇 `401` 自动 refresh，一次失败后跳登录。
  - 处理 refresh 失效场景：清空本地会话并提示重新登录。
- 产出物：
  - 稳定的 API Client 与认证状态管理。
- DoD：
  - token 过期时用户无感恢复（在可刷新前提下）。
  - refresh 失败时行为一致、可预期。

## 阶段 4：核心业务页面（MVP）
- 工作内容：
  - 登录/注册页。
  - 书库页：列表、上传、状态展示、删除、下载。
  - 上传后轮询状态，直到 `ready/failed`。
  - 对话页：提问、回答、出处（sources）展示、历史回显。
- 产出物：
  - 可完整演示主流程的前端版本。
- DoD：
  - 主流程可从头到尾完成，无手工干预。
  - 关键异常场景可处理（文件类型错误、429、409、502）。

## 阶段 5：稳定性与体验优化
- 工作内容：
  - 可用性：空状态、失败重试、操作回执（Toast/Inline Alert）。
  - 性能：懒加载、路由分包、图片延迟加载。
  - 可访问性：键盘导航、可见 focus、语义化标签、对比度检查。
  - 监控：前端错误日志与关键行为埋点（可接 Sentry）。
- 产出物：
  - 发布候选版本（Release Candidate）。
- DoD：
  - 常见交互无卡顿、无明显视觉跳变。
  - 核心页面通过基础可访问性检查。

## 4. 本项目强相关实现约定
- 上传接口字段名固定为 `file`（multipart/form-data）。
- `POST /api/chats` 仅在书籍 `ready` 后调用。
- 书籍状态建议轮询间隔 2~3 秒，超时给用户明确提示。
- 错误结构统一按 `{ "error": "..." }` 处理。
- 遇 `429` 必须提示“稍后重试”，并做按钮短暂禁用。

## 4.1 401 刷新策略（必须按此实现）
- 采用“单飞刷新（single-flight）+ 请求队列重放”：
  - 同一时刻只允许一个 refresh 请求在飞行。
  - 其余因 `401` 失败的请求进入等待队列。
  - refresh 成功后，队列请求使用新 token 重放。
- refresh 失败处理：
  - 立即清空本地会话（`token`、`refreshToken`、用户状态）。
  - 跳转登录页，并提示“会话已失效，请重新登录”。
- 与后端语义对齐：
  - refresh token 轮换是一次性语义。
  - 旧 token 重放会触发 family 撤销，后续 refresh 会持续失败，必须重新登录。

## 4.2 Token 存储与安全约束（必须落实）
- access token：
  - 仅用于 API 鉴权，生命周期短，避免落盘日志。
- refresh token：
  - 仅用于刷新流程，不参与业务接口调用。
- 安全约束：
  - 任何日志、埋点、错误上报中禁止输出完整 token。
  - 对富文本输入统一做转义/白名单渲染，降低 XSS 风险。
  - 前端不信任任何客户端可编辑字段（角色、状态等），权限以后端返回为准。

## 4.3 重试与幂等边界（必须明确）
- 自动重试只用于“读请求或明确幂等请求”：
  - 可自动重试：`GET /api/books`、`GET /api/books/{id}`、`GET /api/users/me`。
  - 谨慎重试：`POST /api/chats`（建议只在明确网络失败且用户可感知时手动重试）。
  - 不自动重试：`POST /api/books`、`DELETE /api/books/{id}`、`POST /api/auth/*`。
- 上传与删除操作：
  - 失败时给用户显式二次确认，不做静默重放。
- 轮询边界：
  - 状态轮询设置总超时（如 2~5 分钟）与最大重试次数，超时后进入人工重试路径。

## 5. 测试策略（前端）
- 单元测试：工具函数、鉴权状态机、API 适配层。
- 组件测试：表单校验、上传交互、错误态渲染。
- E2E 测试（建议 Playwright）：
  - 登录成功与失败。
  - 上传到 ready 的完整链路。
  - 对话提问与出处展示。
  - token 过期后的自动刷新流程。
  - 并发 `401` 下仅一次 refresh 请求（防 refresh 风暴）。

## 6. 分支与交付节奏
- 分支策略：`main` 保护，功能分支小步 PR。
- PR 规则：
  - 只做单一目标。
  - 包含“改动说明 + 测试说明 + 风险点”。
- 里程碑建议：
  - M1：认证 + API 层。
  - M2：书库与上传链路。
  - M3：对话与历史。
  - M4：优化与答辩演示版本。

## 7. 验收清单（答辩向）
1. 用户可注册/登录并保持会话。
2. 用户可上传 `pdf/epub/txt`，并看到处理状态变化。
3. 书籍 `ready` 后可发起问答并看到出处。
4. token 过期可自动刷新；刷新失效可回登录页。
5. 常见错误（400/401/409/429/502）有可理解提示。
6. UI 在桌面与移动端均可用。
