# OneBook AI — Advanced RAG 目标与执行基线

本文档用于固定 OneBook AI 的 RAG 演进目标。后续检索与问答相关改动，默认都应对齐本基线。

## 1. 当前判断（As-Is）
- 当前整体形态：`Modular RAG`（Gateway/Book/Ingest/Indexer/Chat 已模块化）。
- 当前检索能力：仍以 `Naive RAG` 为主（问题向量化 + TopK 向量检索 + 上下文拼接 + 生成）。

## 2. 目标状态（To-Be）
在不引入 Graph RAG / Agentic RAG 的前提下，先完成 `Advanced RAG`。

`Advanced RAG` 的定义：
- 检索前（Pre-retrieval）优化：提升召回覆盖与查询表达质量。
- 检索中（Retrieval）优化：提升相关性排序与上下文有效性。
- 检索后（Post-retrieval）优化：提升答案可追溯性、真实性与稳定性。

## 3. 重点改造范围
### 3.1 检索前（Pre-retrieval）
- 查询改写：口语问题规范化、术语归一、补充检索关键词。
- 多查询召回：复杂问题拆分为 2~N 个子查询并合并候选。
- 分块与元数据治理：持续优化 chunk 粒度与 overlap，保留可过滤元数据（章节/页码/来源等）。

### 3.2 检索中（Retrieval）
- 混合检索：向量检索 + 关键词检索（如 BM25）融合。
- 两阶段检索：先高召回 TopN，再重排（rerank）选出最终上下文。
- 去重与多样性：避免相邻重复 chunk 挤占上下文窗口。

### 3.3 检索后（Post-retrieval）
- 证据约束生成：回答必须基于检索证据并附引用。
- 证据不足兜底：上下文不足时明确说明“无法确定”，禁止臆测。
- 答案后校验：增加 groundedness/引用一致性检查，降低幻觉。

## 4. 里程碑顺序（默认）
1. P0：查询改写 + 多查询召回 + 去重（低风险、收益快）。
2. P1：混合检索（向量 + BM25）与重排链路。
3. P2：答案后校验与质量打分闭环。

## 5. 验收指标（每阶段都要看）
- 检索指标：Recall@K、nDCG@K、MRR。
- 生成指标：答案正确率、引用命中率、幻觉率。
- 工程指标：P95 延迟、单次问答成本、失败率。

## 6. 执行约束
- 默认小步迭代，不做一次性大改。
- 每次改动需明确：问题假设、方案、指标变化、回滚策略。
- 若引入新的 API 字段或错误语义，需同步更新 OpenAPI 与联调文档。

