# OneBook AI — Advanced RAG 实施蓝图（v2）

> 更新时间：2026-02-26  
> 适用范围：`docs/architecture/advanced_rag_plan.md` 对应的所有检索与问答质量改动。

## 0. 文档目的
本文档用于把 OneBook AI 的 RAG 演进从“方向性目标”升级为“可执行蓝图”。

本蓝图同时约束三件事：
- 做什么：Advanced RAG 的目标能力边界。
- 何时算完成：每阶段交付物与退出标准。
- 如何防回退：评测门禁、灰度、回滚机制。

关联文档：
- `docs/product/requirements.md`
- `docs/product/functional_spec.md`
- `docs/architecture/tech_overview.md`

## 1. 产品对齐（Why）
### 1.1 用户价值目标
- 上传书籍后，用户可稳定获得“基于书本证据”的回答。
- 回答需要可追溯（出处可定位），证据不足时明确拒答。
- 在可接受延迟与成本下，保持较高回答正确率。

### 1.2 与 MVP 边界一致
- 当前阶段聚焦 `Advanced RAG`，不引入 Graph RAG / Agentic RAG。
- 继续遵循 MVP 约束：不追求复杂公式/表格高保真还原，不做多人协作权限体系，不做计费系统。

## 2. 现状诊断（As-Is）
- 系统形态：`Modular RAG`（Gateway / Book / Ingest / Indexer / Chat 已模块化）。
- 主链路能力：`Naive RAG` 为主（问题向量化 -> TopK 向量检索 -> 上下文拼接 -> 生成）。
- 已完成能力（M0）：
  - 文档清洗与 chunk 元数据基线。
  - PDF 页级 OCR 触发与 native/OCR 融合。
  - OCR 阈值可配置，基础测试已覆盖。
- 主要缺口：
  - 查询前增强不足（改写、多查询、查询路由尚弱）。
  - 检索中精排不足（混合检索与 rerank 未形成稳定主链）。
  - 生成后校验不足（证据约束、拒答、一致性校验未闭环）。
  - 评测与发布门禁不足（缺统一离线评测集与 CI 阈值阻断）。

## 3. 目标状态（To-Be）
在不引入 Graph/Agent 的前提下，完成 `Advanced RAG`：

- 检索前（Pre-retrieval）：提升查询表达质量与召回覆盖。
- 检索中（Retrieval）：提升召回相关性与上下文有效密度。
- 检索后（Post-retrieval）：提升答案真实性、可解释性与稳定性。
- 评测治理（Eval + Ops）：形成可持续迭代、可回滚的质量闭环。

## 4. 设计原则（How）
- 证据优先：任何答案优先受证据约束，不做“无证据补全”。
- 数据优先：清洗、分块、元数据质量优先于模型调参。
- 小步快跑：默认开关化上线，先灰度后全量。
- 指标驱动：每次改动必须提交“前后指标 + 风险 + 回滚”。
- 兼容优先：对外 API 语义变更必须同步 OpenAPI 与联调文档。

## 5. 目标架构（What）
### 5.1 检索前（Pre-retrieval）
- 文档输入治理：文档分型、清洗规范、OCR 质量门禁。
- 分块治理：结构边界优先（章节/页码），必要时语义补切。
- 元数据契约：统一可过滤、可追溯字段，保证跨服务一致。
- 查询增强：query normalize、术语归一、查询改写、多查询召回。

### 5.2 检索中（Retrieval）
- 混合检索：`dense + sparse(BM25)` 并行召回，融合打分。
- 两阶段检索：`TopN recall -> rerank -> TopK context`。
- 去重与打包：相邻 chunk 去重、多样性约束、窗口利用率优化。
- 失败降级：检索链路异常时可降级到稳定策略。

### 5.3 检索后（Post-retrieval）
- 证据约束生成：默认附引用（页码/章节/source_ref）。
- 证据不足拒答：返回标准化拒答而非推测。
- 一致性校验：答案-引用对齐检查，不通过触发降级或重试。

### 5.4 评测与治理（Eval + Ops）
- 评测集：离线固定集 + 线上抽样回流。
- 指标面板：检索、生成、工程三类指标统一可视化。
- 发布门禁：CI 阈值阻断 + 特性开关 + 快速回滚。

## 6. 元数据与配置契约（Contract）
### 6.1 Chunk 元数据最小必填
- `source_type`
- `source_ref`
- `extract_method`
- `chunk`
- `page/section`（按文档类型可选必填）
- `page_quality_score`（PDF 场景）

### 6.2 核心策略必须开关化
- OCR 开关（已存在）
- 查询改写开关
- 多查询召回开关
- 混合检索开关
- 重排开关
- 拒答策略开关

说明：新增开关需写入 `.env.example` 与 README，并给默认值与回滚值。

## 7. KPI 与发布门禁（Definition of Success）
> 先建立 M0 基线，再执行目标阈值。若无历史基线，默认“不低于当前稳定版”。

| 维度 | 指标 | M0 基线 | M3 目标 | 发布门禁 |
|---|---|---:|---:|---|
| 检索 | Recall@20 | 待测 | +10%（相对） | 不低于稳定版 -2% |
| 检索 | nDCG@10 | 待测 | +10%（相对） | 不低于稳定版 -2% |
| 检索 | MRR@10 | 待测 | +8%（相对） | 不低于稳定版 -2% |
| 生成 | 引用命中率 | 待测 | >= 90% | < 85% 阻断 |
| 生成 | 幻觉率 | 待测 | <= 8% | > 12% 阻断 |
| 生成 | 拒答正确率 | 待测 | >= 85% | < 80% 阻断 |
| 工程 | 问答 P95 延迟 | 待测 | 增幅 <= 20% | 超预算阻断 |
| 工程 | 单问答成本 | 待测 | 增幅 <= 15% | 超预算阻断 |
| 工程 | 失败率 | 待测 | <= 1% | > 2% 阻断 |

## 8. 里程碑（M0-M5）
以下按“先质量基线 -> 再检索增强 -> 最后门禁治理”推进。

### M0：基线固化（已完成）
目标：完成清洗与页级 OCR 融合基线。

交付：
- 文档清洗与 chunk 元数据规范落地。
- OCR 页级触发与 native/OCR 融合机制落地。
- 阈值可配置，测试覆盖到位。

退出标准：
- `cd backend && go test ./...` 通过。
- chunk 元数据可追溯提取方式与来源位置。

### M1：检索前增强（进行中）
目标：提升召回覆盖，降低“问法偏差导致漏召回”。

关键交付：
- Query normalize + 术语归一。
- 查询改写（可开关）与多查询召回。
- 分块升级（结构优先）与增量重建、幂等重跑。

退出标准：
- 固定评测集 Recall@K 相比 M0 可量化提升。
- P95 延迟增幅在预算内。

### M2：检索中增强
目标：从“召回到”升级为“召回准”。

关键交付：
- 混合检索（dense + BM25）主链上线。
- 两阶段检索（TopN + rerank）。
- 去重与上下文打包策略。

退出标准：
- nDCG@K、MRR 明显提升。
- 重复 chunk 比例下降，上下文有效密度提升。

### M3：检索后与生成约束
目标：降低幻觉，提高可解释性。

关键交付：
- 证据约束生成模板。
- 证据不足拒答策略。
- groundedness / 引用一致性后校验。

退出标准：
- 引用命中率达标。
- 幻觉率与拒答正确率达到门槛。

### M4：评测与发布门禁
目标：形成“持续评测 -> 自动门禁 -> 可回归”的闭环。

关键交付：
- 固定离线评测集 + 线上抽样回流。
- 指标看板与版本对比报告。
- CI 阈值阻断与失败回归报告模板。

退出标准：
- 关键改动均可产出可复现实验结果。
- 门禁在主分支稳定运行。

### M5：运维治理与灰度
目标：降低线上变更风险，提升可运营性。

关键交付：
- 特性开关与灰度策略。
- 成本预算、异常告警、回滚预案。
- 运行手册（故障定位与应急处理）。

退出标准：
- 新策略支持按流量分批启用。
- 发生异常可在预设窗口内回滚。

## 9. 执行清单（按优先级）
### 9.1 P0（立即）
- T1：查询清洗与改写管线（开关化）。
- T2：多查询召回与合并去重。
- T3：结构化分块升级 + 增量重建。

### 9.2 P1（紧随）
- T4：混合检索上线与融合策略配置化。
- T5：重排器接入与两阶段链路。
- T6：上下文打包、多样性与窗口利用优化。

### 9.3 P2（质量护栏）
- T7：证据约束输出模板。
- T8：证据不足拒答。
- T9：答案-引用一致性校验与降级策略。

### 9.4 横切任务（并行）
- T10：评测集建设与切片。
- T11：指标落盘、看板、回归报告。
- T12：CI 门禁、特性开关、回滚手册。

## 10. 变更治理（必须执行）
每个策略改动 PR 必须包含：
- 问题假设：要解决的具体 bad case。
- 方案描述：链路变化与开关默认值。
- 指标对比：至少给出离线评测前后结果。
- 风险与回滚：失败条件、回滚路径、回滚命令。
- 文档同步：涉及 API 语义变更时同步 OpenAPI 和联调文档。

## 11. 风险清单与应对
- 风险1：检索提准导致延迟上升。
  - 应对：两阶段检索参数化，设置 P95 与成本双门禁。
- 风险2：多查询召回带来噪声上升。
  - 应对：融合后去重 + rerank + 最大上下文预算控制。
- 风险3：拒答策略过严导致“该答不答”。
  - 应对：拒答正确率单独评测，支持按场景阈值调优。
- 风险4：新链路上线影响稳定性。
  - 应对：默认关 + 小流量灰度 + 快速回滚。

## 12. 当前阶段不做（明确非目标）
- Graph RAG。
- Agentic RAG。
- 多人协作权限层级。
- 计费与精细化配额系统。
- 重型合规体系（先做最小必要日志治理与敏感信息控制）。

## 13. 下一步（建议立即执行）
- S1：建立 M0 离线评测基线（先出第一版指标盘点）。
- S2：落地 T1（query normalize + 改写开关）并完成 A/B 对比。
- S3：落地 T2（多查询召回）并评估复杂问题切片收益。

